name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  test-and-audit:
    name: Test, Audit & Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Python Security Audit (Bandit)
        run: |
          pip install bandit
          bandit -r . -x ./venv

      - name: Validate App Spec
        uses: digitalocean/app_action/deploy@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
          # Use 'print_only' to validate the spec without deploying 
          # during the audit phase
          print_only: "true" 

  deploy:
    name: Deploy
    needs: test-and-audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to DigitalOcean
        id: deploy
        uses: digitalocean/app_action/deploy@v2
        with:
          # This flag tells DO to create a NEW temporary app for PRs
          # but update the EXISTING app for pushes to main
          deploy_pr_preview: ${{ github.event_name == 'pull_request' && 'true' || 'false' }}
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Comment PR with Link
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸš€ **PR Preview Deployed!**\nURL: ${{ fromJson(steps.deploy.outputs.app).live_url }}`
            })