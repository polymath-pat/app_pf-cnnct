name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-and-validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install flake8

      - name: Lint with flake8
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Validate App Spec
        run: doctl apps spec validate spec.yaml

  deploy:
    needs: test-and-validate
    # Only deploy on push to main, not on Pull Requests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Trigger DigitalOcean Deployment
        run: |
          # This updates the app with the latest spec and waits for DO to finish the rollout
          doctl apps update ${{ secrets.DIGITALOCEAN_APP_ID }} --spec spec.yaml --wait

  health-check:
    needs: deploy
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
  
      - name: Fetch App URL
        id: get_url
        run: |
          RAW_URL=$(doctl apps get ${{ secrets.DIGITALOCEAN_APP_ID }} --format DefaultIngress --no-header)
          echo "APP_URL=$RAW_URL" >> $GITHUB_ENV
          echo "Detected App URL: $RAW_URL"
  
      - name: Probe Application Endpoint
        run: |
          # UPDATED: Use the /healthz endpoint or the new /api/cnnct path
          # Probing /healthz is best as it bypasses rate limiting
          TARGET_URL="${{ env.APP_URL }}/healthz"
          
          echo "Probing $TARGET_URL..."
          # Max 5 retries to account for cold starts
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" --retry 5 --retry-delay 5 "$TARGET_URL")
          
          if [ "$STATUS" -eq 200 ]; then
            echo "✅ Health check passed!"
          else
            echo "❌ Health check failed with status $STATUS"
            exit 1
          fi
  
      - name: Rollback on Health Check Failure
        if: failure()
        run: |
          echo "Initiating rollback..."
          # Get the ID of the SECOND active/successful deployment (the one before the failed one)
          PREV_DEPLOY_ID=$(doctl apps list-deployments ${{ secrets.DIGITALOCEAN_APP_ID }} --format ID,Phase --no-header | grep "ACTIVE" | awk 'NR==2 {print $1}')
          
          if [ -n "$PREV_DEPLOY_ID" ]; then
            doctl apps rollback ${{ secrets.DIGITALOCEAN_APP_ID }} --deployment-id $PREV_DEPLOY_ID --wait
          else
            echo "No valid previous deployment found."
            exit 1
          fi